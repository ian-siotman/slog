들어가기 앞서 먼저 버짓설정 해두는게 좋다. 오른쪽 상단 계정 드롭다운메뉴에서

Billing Management > Budgets > Cost Budget 타입 > 설정

# EC2

## 개관

- EC2 : Elastic Compute Cloud
- 주요 구성요소
    - VM 대여 (EC2)
    - 가상저장공간 (EBS)
    - 로드밸런서 (ELB)
    - 오토 스케일링 (ASG)
- 클라우드에서 가장 기본적이다.

### sizing, Config 옵션

- OS : 리눅스, 윈도, 맥
- CPU
- RAM
- Storage
    - 네트워크 (EBS, EFS)
    - 하드웨어 (EC2 Instance Store)
- 네트워크 카드, Public Ip
- 방화벽 규칙(Security Group)
- EC2 User Data (인스턴스 초기화용 부트스트랩 스크립트)
- 등등등

### EC2 User Data

- 시작할 때 한번 실행됨
- 부팅할 때 초기화할 작업들 이걸로 하면 됨
- 루트 유저로 스크립트 실행해야하므로, 수도 붙여야함

## EC2 리눅스 실행시키기

EC2 > 리전선택 > Instances > Launch > AMI (Amazon Machine Image) 선택 > 여러가지 템플릿 쓸 수 있음

일단 프리티어용 리눅스 템플릿 선택 > 인스턴스 타입 선택 > 디테일 옵션은 우선 그대로, 확인용으로 html 생성하는 EC2 User Data 만 입력

스토리지 설정도 일단 디폴트 > Security Group, Http 만 열기

키 페어 생성 및 저장 (일단 생성하면 재생성 불가능하므로 잃어버려선 안된다.) > 런치

Instances 메뉴에서 실행 중인 인스턴스 확인 가능

특별한 설정이 없다면 퍼블릭 아이피가 부여되어있음

껐다키면 그게 바뀜

- Stop : 요금 안나오고 그냥 꺼지는 거임
- Terminate : 자원반환

## 인스턴스 타입

공식문서 설명 : https://aws.amazon.com/ec2/instance-types/

- ex) `m5.2xlarge`
    - m5 : m 클래스의 5번째 제너레이션
    - 2xlarge : 해당 클래스의 사이즈

- 범용, Compute 최적화, 메모리 최적화, 네트워크 최적화 클래스 등등

### CPU Opt. 클래스

- 시피유 많이 쓰는 인스턴스면 쓸만함
- 클래스 c 로 표현됨

### RAM Opt. 클래스

- 캐시, 디비, 인메모리 디비, 리얼타임 어플리케이션에 좋음
- R 클래스로 표현됨. 알파벳 다르게도 표현하는데 따로 찾아보면 될듯

### 기타 등등

스토리지 최적화(d, H) 등이 있음

https://www.ec2instances.info/ 에서 더 자세히 볼 수 있음

## Security Groups

AWS 에서 방화벽처럼 동작함

- Port
- IP ranges
- 인바운드 네트워크
- 아웃바운드 네트워크

자격증 시험 상에서 적절한 시큐리티 그룹 설정을 묻진 않으나, 중요하다.

기본적으로 인바운드 설정 상 허락된 것만 인바운드 요청을 통과시키고, 나머지는 통과안시키니 타임아웃처리될거다.
아웃바운드 디폴트 설정은 모두 허용이다.

시큐리티 그룹은

- ec2 : group = 1 : N
- 리전 + /VPC 조합에 종속된다. -> 새로운 조합이라면 그룹이 새로 만들어져야한다.
- Ec2 밖에 존재한다.
- ssh 를 위한 별도의 그룹을 만들어두는게 좋다
- 타임아웃이면 대부분 그룹이 문제다.
- 커넥션 리퓨즈이면 통과는 됐는데 서버가 튕겨낸거다.
- 모든 인바운드 트래픽은 디폴트로 막혀있다.
- 모든 아웃바운드 트래픽은 디폴트로 authorized 이다.

### Security Group Reference

g1, g2, g3 라는 시큐리티 그룹이 있고, ec2_1, ec2_2, ec2_3 가 있으며

각 ec2 에 각 시큐리티 그룹이 붙어있다고 가정하자.

- g1 이 g1, g2 를 레퍼런싱 할 수 있다.
- 그렇다면 g3 트래픽은 튕겨낼 것이다.

### 기본적인 Port

- 22 : ssh
- 21 : ftp
- 22 : sftp - file using ssh
- 80 : http
- 443 : https
- 3389 : RDP (Remote Desktop Protocol) - 윈도우 인스턴스 로긴

### Practice : 시큐리티 그룹

EC2 > Network & Security > Security Groups

디폴트가 있는 걸 볼 수 있다.
열어보면 아이디 값 등이 있고, 인바운드 아웃바운드 탭이 있는 걸 볼 수 있다.
그룹을 편집, 생성 할 수 있다.

여러가지 사전정의된 포트가 있는걸 볼 수 있고, 특정 TCP 로 커스터마이징 할 수 있다.

시큐리티 그룹을 레퍼런싱할려면 소스에 시큐리티 아이디값을 넣으면 된다. 

## ssh

windows < 10 은 ssh 지원안한다. 푸티써라

EC2 Instance Connect 라는 것도 있는데 그건 다 지원한다.

일단 공인아이피 쓰면 되고 ec2-user 가 기본 유저이니 참고.

받아놓은 pem 파일을 레퍼런싱해서 접속하면 된다.

`ssh -i 000.pem ec2-user@255.255.255.255`

파일 퍼미션이 예를들어 0644 이면 키가 너무 오픈되어있다고 에러뜰 수 있다. chmod 0400 으로 바꿔주면된다.

whoami 한번 찍어보고 오자. exit 혹은 logout 해서 나오자

## EC2 Instance Connect

모든 AMI 가 되는건 아니고 다른건 안될 수도 있음.

EC2 메뉴에서 인스턴스 클릭하고 커넥트 버튼 누르면 됨.

ssh 로 지원하는거니까 시큐리티 그룹에 ssh 없으면 이것도 안됨.

## Practice: IAM role + EC2

ec2 상에서 aws configure 로 크레덴셜 입력하는건 바람직 하지 않다. 끔찍한 일이다. - IAM roles 를 쓴다.

IAM > Roles 로 생성했던 롤을 등록해보자

EC2 > 인스턴스 목록에서 인스턴스 체크 > 액션 > 시큐리티 > 모디파이 아이엠 롤 > 만든거 선택하고 붙이면 됨

그다음 aws iam list-users 해보자 (물론 iam read only 이상의 폴리시 있는 롤을 붙여야 이게 됨)

## 인스턴스 타입

지금까지 온디맨드 인스턴스를 살펴봄 다른것도 있음

- Reserved (최소 1년)
    - reserved instances : 디비같은거
    - Convertible Reserved Instances
    - Scheduled Reserved Instances
- Spot Instances : 짧은 워크로드, 싸고, 잃을 수 있음
- Dedicated Hosts : 완전한 물리 서버를 예약함. 위치도 컨트롤 함.

### 온디맨드

- 쓴만큼 쓴다.
    - 리눅스 : 1분 이후 초 단위 빌링
    - 다른 오에스 : 시간당 빌링
- 후불
- 약정 필요없음
- 짧은 기간, 인터럽스 없는, 어떻게 행동할지 예측불가한 앱일 때 사용

### 리저브드

- 75% 까지 디스카운트
- 1 or 3 년 약정
- 선불없음 (월결제), 부분선불, 완전선불
- 특정 타입을 리저브
- 스테디한 어플리케이션에 유용

### 컨버터블 리저브드

- 타입을 바꿀 수 있음
- 54% 까지 디스카운트

### 스케쥴드 리저브드

- 특정 시간 윈도우에 런치
- 그래도 1년 혹은 3년 약정

### 스폿

- 90% 까지 디스카운트
- 어제든 인스턴스 잃을 수 있다. - 맥스 프라이스가 최근 스폿 프라이스보다 낮으면
- 가성비 좋음
- 실패에 유연한 워크로드에 유용
    - 배치 잡
    - 데이터 분석
    - 이미지 프로세스
    - 분산 워크로드 - 레플리카 실패해도 상관없는 분산된 애들 등
    - 유연한 시작 / 끝 시간을 같은 워크로드
- 디비에 쓰면 클나겠지?

### Dedicated Hosts

- 물리 서버 할당한단 말. 
- 컴플 필요사항을 조정 가능. 
- 갖고있는 서버바운더리 소프트웨어 라이센스를 사용가능함.
- 3년 약정 필요
- 좀더 비쌈
- 라이센스 모델이 복잡하면 유용함
- 규제 혹은 법적이슈를 가진 회사들에 유용

### Dedicated Instances

- 이씨투 돌리는 하드웨어가 내게 할당된단 말
- 내 계정 상 다른 이씨투가 이 하드웨어를 공유할 수 있음
- 인스턴스 위치에 대해선 컨트롤할 수 없음

### 어떤 인스턴스를?

- 온디맨드 : 리조트
- 리저브드 : 롱스테이 호텔
- 스팟 : 호텔이 빈 방을 주긴하는데, 더 돈주는 사람있으면 쫓아내는 이상한 호텔방
- 할당 호스트 : 리조트 전체 빌딩 빌리는것



