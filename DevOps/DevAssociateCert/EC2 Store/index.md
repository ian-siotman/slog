# EC2 Instance Store

## EBS

- Elastic Block Store 로써 네트워크 볼륨
- ec2 돌고 있어도 붙일 수 있음
- ec2 꺼도/terminate 해도 그대로 유지할 수 있음
- 1개는 한 인스탠스에 붙을 수 있음 (한 인스탠스가 여러개 가질 순 있음)
- availability zone 에 종속적임음

- 네트워크 드라이브
    - 레이턴시 있을 수 있음
    - 한 인스턴스에 붙어있다가 떼서 다른 인스턴스에 붙일 수 있음
    
- AZ 에 종속적임
    - 다른 리전 인스턴스에 붙일 수 없음
    - 옮기기 위해선 먼저 스냅샷을 떠야함
    
- 케파를 미리 프로비저닝해야함
    - 시간이 지나고 케파를 늘릴 수 있음
    
- 반드시 attached 상태일 필요 없음

### Delete on Termination attribute

- EBS 목록에서 이 옵션이 있음.
- 디폴트로 루트는 체크되어있음 
- 다른 이비에스는 언체크드
- 콘솔이나 cli 로 조작가능
- ec2 종료시킬 때 루트를 프리저브할 수 있음

### Practice

인스턴스 목록에서

Sotrage 탭 > 볼륨 아이디 누르면 볼룸메뉴

볼륨생성 > 유형선택 > 사이즈 선택 > 가용영역 선택

여기서 EC2 에 따라 ap-northeast-2a / ap-northeast-2b, c, d 선택 > 생성

볼륨 메뉴에서 방금생성한 볼륨 오른쪽 클릭 > 볼륨 연결

인스턴스 메뉴 > 스토리지 탭 에서 붙은거 확인 가능

실제로 리눅스 상에서 EBS 쓸 수 있도록 하는 건 조금더 작업해야하지만 일단 여기까

다른 리전으로 생성하면 연결하려할 때 인스턴스가 안보이는 걸 확인할 수 있다.

종료하면 루트가 사라지고 생성했던건 살아있는걸 볼 수 있

## EBS 스냅샷

- 특정시점 백업임
- 디테치에 필수사항은 아니지만 추천되고있음
- 스냅샷은 리전 어크로스 가능

### 스냅샷 연습

볼륨 > 액션(작업) > 스냅샷 생성  

스냅샷 메뉴 > 결과 볼 수 있음

액션 > 카피 > 다른리전으로 카피 가능
액션 > 볼륨생성 > 스냅샷으로 가능

## AMI (Amazon Machine Image)

- 이씨투의 커스터마이제이션이다
    - 소프트웨어, 오에스, 모니터링, 설정 등 추가 가능
    - 설정, 소프트웨어 등을 미리 패키징 해놓기에 부트가 빠름
- ami 는 특정 리전을 위해 만들어졌고 리전사이 카피가 가능함

- 퍼플릭 에이엠아이
- 오운 에이엠아이 
- 마켓플레이스 에이엠아이

### 프로세스

1. ec2 를 시작시키고 커스터마이징한다
2. 데이터 통합을 위해 인스턴스를 멈춘다
3. 이걸로 ami 를 빌드한다. EBS 스냅샷도 만든다.
4. 빌드한 걸로 인스턴스들을 만든다.

### ami 만들기 프랙티스

EC2 User Data 넣고 인스턴스 생성 

인스턴스 목록에서 생성한 인스턴스 우클 > 이미지 엔드 템플릿 > 이미지 생성 > 설정하고 생성

인스톤스 새로만들어보면 내 AMI 에서 방금 만든거 볼 수 있음 (만드는데 살짝 걸림. 목록에 보이려면 조금 기달)

## EC2 Instance Store

- EBS 는 퍼포먼스가 제한적임
- EC2 Instance Store 는 하드웨어 디스크를 말함

- 아이오 퍼포먼스가 더 좋음
- EC2 멈추면 잃음
- 버퍼, 캐시, 스크래치 데이타, 임시 컨텐츠 등에 좋음
- 하드웨어 페일 때문에 데이터 잃을 수 있는 리스크 있음
- 백업이랑 레플리케이션이 필요할 수 있음

- IOPS 가 IO per seconds 란 말로, 속도를 나타냄
- Local EC2 Instance Store : IOPS 가 높음

## EBS 볼륨 타입

- 6타입 있음
    - gp2 / gp3 (ssd) : 범용 ssd
    - io1 / io2 (ssd) : 하이스트 퍼포먼스 ssd
    - st1 (hdd) : 저렴
    - sc1 (hdd) : 제일 저렴
    
- Size / Throughput / IOPS 로 특징잡을 수 있음
- 도큐멘트 참조
- gp2/3 이랑 io1/2 만 루트로 쓰임

### gp ssd

- 가성비, 낮은 지연
- 부트볼륨, 가상 데탑, 개발 / 테스트 환경
- 1 gib ~ 16 tib
- gp3
    - 3000 iops  125 mib/s throughput 베이스라인
    - iops 6000 까지, 1000 throughput 까지 독립적으로 늘릴 수 있음
- gp2
    - 작은 볼륨은 3000 iops
    - 사이즈랑 iops 가 연결되어있어서 16000 까지
    - 3 iops per GB, 즉 사이즈 5334 GB 이면 iops 가 맥스란 뜻
    - 스로우 풋 링크드
    \
    
### Provisioned IOPS (PIOPS) SSD

- 퍼포먼스 유지시켜야하는 비지니스 앱
- 디비 워크로드가 예가 될 수 있음
- io1/io2 (4 gib - 16Tib)
    - PIOPS: 64000 for Nitro EC2 instances & 32000 for other
    - 사이즈와 상관없이 PIOPS 증가 가능
    -  io2 가 가격대비 좀더 내구성이 좋고 iops 가 좋음
- io2 Block Express (4Gib ~ 64tib)
    - Sub-millisecond latency
    - Max PIOPS: 256,000 with an IOPS : GiB =  1000 : 1 
- EBS 멀티 어테치 지원

### HDD

- 부트 루트로 적합하지 않음
- 126 m ~ 16 t
- 처리량 최적화 (st1) 타입
    - 빅데이터, 웨어하우스, 로그 프로세스
    - 500 mib/s max , 500 iops max
- Cold HDD (sc1) 타입
    - 자주 접근 안하는거
    - 제일 저렴
    
너무 자세히 다 외워놓을 필욘 없고 적당한 차이정도 기억해두자

## EBS Multi-Attach - io1/io2

- 같은 AZ 내에서 여러 인스턴스에 붙을 수 있음
- 각 인스턴스가 rw 가짐
- use case
    - 클러스터된 리눅스 앱에 높은 가용성 챙겨야할 때
    - 쓰기 작업 동시성을 가져야할 때
- cluster-aware 파일 시스템을 써야함
    - XFS, Ex4 ... 등등은 안됨
    
## EFS - Elastic File system

- ec2 에 마운트 가능한 Managed NFS (network file system)
    - N 개 인스턴스, 여러 AZ 을 가로질러서
- 멀티 AZ
- 높은 가용성, 확장성, 비싸고 (3 x gp2), 사용한만큼 냄
- EFS 에 시큐리티 그룹 붙여 

- 컨텐츠 관리, 웹서빙, 데이터 공유, 워드프레스 등에 쓰일 수 있음
- NFSv4.1 프로토콜 사용
- 시큐리티 그룹 씀
- 리눅스 베이스 AMI 만 쓸 수 있음
- rest 에 KMS 로 암호화 가능
- 스탠다드 파일 api 같는 POSIX 파일 시스템
- 오토 스케일링, 쓴만큼 쓰니 케파에 신경쓸 필요 없음

### 퍼포먼스와 스토리지 클레스들

- EFS Scale
    - 1000 동접 클라이언트, 10 GB / s + 처리량
    - 페타바이트까지 스케일링가능
- 퍼포먼스 모드 (EFS 생성할 때 설정)
    - General Purpose (default) : 지연민감 유즈케이스 (웹서버, CMS ...)
    - Max I/O - 높은 지연, 처리량, 높은 병렬처리 (빅데이, 미디어 프로세싱)
- 처리량 모드
    - Bursting (1 TB = 50Mib/s + busrt of up to 100Mib/s)
    - Provisioned : 스토리지 크기 상관없이 처리량 설정
- 스토리지 티어 (라이프사이클 관리 피쳐 - n 일 뒤 파일을 옮김)
    - Standard : 파일어세스 자주할 때
    - Infrequent access (EFS-IA) : 파일 어세스할 때 비용들고, 저장에 비용 낮
    
### 실습

EFS > 사용자지정 > 수명주기관리

돈 절약시켜주는 설정 - 자주 어세스 안하는 파일은 자동으로 EFS-IA 로 n 일 뒤 옮겨줌

성능모드, 처리량 모드 볼 수 있고

처리량 모드 프로비전드로 하면 처리량 설정 가능

유휴시 암호화 설정 가능  

네트워크 액세스 셋팅 > az 에 따라 보안그룹 설정

파일시스템 폴리시 - 옵셔널 > 생성

인스턴스 2개 만들어 붙여볼 수 있음 (서브넷 항목에서 az 바꿔서 테스트)

EFS > attach > Mount via DNS

그 모달의 유저 가이드에서 볼 수 있듯이 ec2 에 amazon-efs-utils 패키지 설치해야함

수도 얌 인스톨 -y amazon-efs-utils

이제 ec2 에 efs 디렉토리 만들고

sudo mount -t efs -o tls 아이디:/ efs

타임아웃나면 시큐리티 그룹을 확인

인바운드룰에 NFS (2049 포트), 대상 이시투 보안그룹 소스

## EFS vs EBS vs Instance Store

차이점 알아둘 것




    